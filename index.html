<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jupiter Tracker — Dark • Free Nav • Samedan</title>
  <meta name="theme-color" content="#0b1020" />
  <style>
    :root{--bg:#0b1020;--panel:#0f172a;--muted:#93a3b8;--text:#e5e7eb;--accent:#22c55e;--blue:#3b82f6}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:10px 14px;border-bottom:1px solid #1f2937;display:flex;gap:10px;align-items:center;justify-content:space-between}
    h1{font-size:18px;margin:0}
    main{display:grid;grid-template-columns:320px 1fr;gap:12px;padding:12px}
    @media (max-width:900px){main{grid-template-columns:1fr}}
    .card{background:var(--panel);border:1px solid #1f2937;border-radius:12px;padding:12px}
    label{font-size:12px;color:var(--muted)}
    input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #243044;background:#0c1426;color:var(--text)}
    button{cursor:pointer;font-weight:700}
    .row{display:flex;gap:8px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .pill{display:inline-block;border:1px solid #243044;border-radius:999px;padding:6px 10px;color:#9fb0c6;font-size:12px}
    #mapwrap{position:relative}
    #celestial-map{width:100%;height:auto;display:block}
    #overlay{position:absolute;inset:0;pointer-events:none}
    .legend{position:absolute;left:8px;bottom:8px;color:#a3b3c7;font-size:12px;background:rgba(15,23,42,.8);padding:6px 8px;border-radius:8px;border:1px solid #243044}
    .footer{padding:10px 14px;color:#94a3b8;font-size:12px;text-align:center}
    a{color:#a5b4fc;text-decoration:none}
  </style>
  <!-- Celestial.js (D3-based sky map) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/ofrohn/d3-celestial@master/celestial.css">
  <script defer src="https://d3js.org/d3.v4.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/gh/ofrohn/d3-celestial@master/celestial.min.js"></script>
  <!-- Supabase JS (auth + database). Fill in your project details below. -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Jupiter Tracker</h1>
    <div class="pill" id="status">not signed in</div>
  </header>

  <main>
    <aside class="card" id="authCard">
      <h3 style="margin-top:0">Sign in</h3>
      <p style="margin:6px 0 10px;color:#9fb0c6">Email magic link or guest session.</p>
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" />
      <div class="row" style="margin-top:8px">
        <button id="emailLogin">Send magic link</button>
        <button id="guestLogin" title="Temporary session">Continue as guest</button>
      </div>
      <hr style="border-color:#1f2937;margin:12px 0">
      <div class="grid2">
        <button id="signOut">Sign out</button>
        <button id="refreshPositions">Refresh positions</button>
      </div>
      <p id="authMsg" style="color:#fde68a"></p>

      <hr style="border-color:#1f2937;margin:12px 0">
      <div style="color:#9fb0c6;font-size:13px;line-height:1.4">
        <b>Rules:</b>
        <ul style="margin:8px 0 0 18px">
          <li>Planets are hidden. Find Jupiter by star pattern only.</li>
          <li>Timestamp is always <b>current UTC</b>.</li>
          <li>Location is fixed: <b>Samedan</b> (46.534 N, 9.872 E).</li>
        </ul>
      </div>
    </aside>

    <section class="card">
      <div id="mapwrap">
        <canvas id="celestial-map" width="1400" height="1400" aria-label="Sky map"></canvas>
        <svg id="overlay"></svg>
        <div class="legend">Tap to add a point • Clean dark sky • Jupiter hidden</div>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="pill" id="lastClick">last: —</div>
        <div class="pill" id="count">points: 0</div>
        <div class="pill">Observatory: Samedan (46.534, 9.872)</div>
      </div>
    </section>
  </main>

  <div class="footer">Stores RA/Dec + current UTC + fixed Samedan coordinates in Supabase. Free navigation; no constellations/grid/labels shown by default.</div>

<script>
// ===================== FIXED SETTINGS =====================
const LAT_SAMEDAN = 46.534;
const LON_SAMEDAN = 9.872; // east positive

// ===================== CONFIGURE SUPABASE =====================
const SUPABASE_URL = "https://qunlkfmgvkmhgkmvrrty.supabase.co";  // <-- replace
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF1bmxrZm1ndmttaGdrbXZycnR5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE4NDY1MjcsImV4cCI6MjA3NzQyMjUyN30.pWZsFCu0eq95VnQ3C_5F_Hv8FLJGDZDo2qcyxPRk6RE";                // <-- replace
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===================== AUTH =====================
const statusEl = document.getElementById('status');
const authMsgEl = document.getElementById('authMsg');
const emailEl = document.getElementById('email');

async function setSessionInfo() {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    statusEl.textContent = `signed in: ${user.email || 'guest'}`;
    authMsgEl.textContent = '';
  } else {
    statusEl.textContent = 'not signed in';
  }
}

async function emailLogin() {
  const email = emailEl.value.trim();
  if (!email) { authMsgEl.textContent = 'Enter an email.'; return; }
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  authMsgEl.textContent = error ? `Error: ${error.message}` : 'Check your inbox for a magic link.';
}
async function guestLogin() {
  const { error } = await supabase.auth.signInAnonymously();
  authMsgEl.textContent = error ? `Error: ${error.message}` : 'Guest session active.';
  setSessionInfo();
}

document.getElementById('emailLogin').onclick = emailLogin;
document.getElementById('guestLogin').onclick = guestLogin;
document.getElementById('signOut').onclick = async () => { await supabase.auth.signOut(); setSessionInfo(); };

supabase.auth.onAuthStateChange((_event, _session) => setSessionInfo());
setSessionInfo();

// ===================== SKY MAP (D3-Celestial) =====================
const mapCfg = {
  container: 'celestial-map',
  width: 0,                    // auto fit to container
  projection: 'aitoff',
  datapath: 'https://cdn.jsdelivr.net/gh/ofrohn/d3-celestial@master/data/',
  form: false,
  controls: true,              // zoom/pan controls
  interactive: true,
  negative: true,              // dark theme
  constellations: { names: false, lines: false, bounds: false }, // clean sky
  stars: { show: true, limit: 8, colors: true },
  dsos: { show: false },
  planets: { show: false },   // <— hide all planets (no Jupiter)
  mw: { show: true },
  background: { fill: 'transparent', stroke: '#192033', opacity: 0.7 },
  horizon: { show: true },
};

function refreshMap() {
  // Fixed observer location (Samedan) and current time
  Celestial.location([LON_SAMEDAN, LAT_SAMEDAN]);
  Celestial.date(new Date());

  // Fit to container width
  const wrap = document.getElementById('mapwrap');
  mapCfg.width = Math.max(320, wrap.clientWidth - 2);
  Celestial.display(mapCfg);
  // Basic sanity check to help troubleshooting
  const c = document.getElementById('celestial-map');
  if (!c.width || !c.height) {
    console.warn('Celestial canvas has zero size. Ensure you are viewing via GitHub Pages or a local server.');
  }
  drawOverlays();
}

function drawOverlays() {
  const overlay = d3.select('#overlay');
  overlay.selectAll('*').remove();

  // community points
  if (layerCommunityVisible) {
    overlay.append('g').attr('id','gCommunity')
      .selectAll('circle').data(communityPoints).enter()
      .append('circle')
      .attr('r', 3.5)
      .attr('fill', 'none')
      .attr('stroke', 'rgba(34,197,94,0.85)')
      .attr('stroke-width', 1.5)
      .attr('cx', d => Celestial.mapProjection(Celestial.coord(d.ra, d.dec))[0])
      .attr('cy', d => Celestial.mapProjection(Celestial.coord(d.ra, d.dec))[1])
      .attr('opacity', 0.9);
  }
  // my points
  if (layerMyVisible) {
    overlay.append('g').attr('id','gMine')
      .selectAll('circle').data(myPoints).enter()
      .append('circle')
      .attr('r', 5)
      .attr('fill', 'none')
      .attr('stroke', 'rgba(59,130,246,0.95)')
      .attr('stroke-width', 1.8)
      .attr('cx', d => Celestial.mapProjection(Celestial.coord(d.ra, d.dec))[0])
      .attr('cy', d => Celestial.mapProjection(Celestial.coord(d.ra, d.dec))[1])
      .attr('opacity', 1.0);
  }
}

// Handle clicks -> record RA/Dec at current UTC, fixed Samedan lat/lon
const lastClickEl = document.getElementById('lastClick');
const countEl = document.getElementById('count');
let myPoints = [], communityPoints = [];
let layerCommunityVisible = true, layerMyVisible = true;

function attachClickHandler() {
  d3.select('#celestial-map').on('click', function() {
    const m = d3.mouse(this); // [x,y] in pixels
    const inv = Celestial.mapProjection.invert(m);
    if (!inv) return;
    const raDeg = inv[0];
    const decDeg = inv[1];
    const tISO = new Date().toISOString(); // current UTC

    const p = { ra: raDeg, dec: decDeg, obs_time: tISO, lat: LAT_SAMEDAN, lon: LON_SAMEDAN };
    myPoints.push(p);
    countEl.textContent = `points: ${myPoints.length}`;
    lastClickEl.textContent = `last: RA ${p.ra.toFixed(3)}°, Dec ${p.dec.toFixed(3)}° at ${p.obs_time}`;
    drawOverlays();
    saveObservation(p);
  });
}

// Initial draw and bind click handler after first display
window.addEventListener('load', () => { refreshMap(); attachClickHandler(); });
window.addEventListener('resize', () => { refreshMap(); });

// ===================== DATA STORAGE (Supabase) =====================
async function saveObservation(p) {
  const { data: { user } } = await supabase.auth.getUser();
  const payload = {
    user_id: user ? user.id : null,
    ra_deg: p.ra,
    dec_deg: p.dec,
    obs_time: p.obs_time,
    lat: p.lat,
    lon: p.lon,
  };
  const { error } = await supabase.from('observations').insert(payload);
  if (error) console.error('Insert error', error);
}

async function loadMyObservations() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { myPoints = []; drawOverlays(); return; }
  const { data, error } = await supabase
    .from('observations')
    .select('ra_deg, dec_deg, obs_time, lat, lon')
    .eq('user_id', user.id)
    .order('obs_time', { ascending: true });
  if (error) { console.error(error); return; }
  myPoints = (data||[]).map(r => ({ ra: r.ra_deg, dec: r.dec_deg, obs_time: r.obs_time, lat: r.lat, lon: r.lon }));
  drawOverlays();
}

async function loadCommunityObservations() {
  const { data, error } = await supabase
    .from('observations_public') // a view that strips user_id
    .select('ra_deg, dec_deg, obs_time')
    .order('obs_time', { ascending: true });
  if (error) { console.error(error); return; }
  communityPoints = (data||[]).map(r => ({ ra: r.ra_deg, dec: r.dec_deg, obs_time: r.obs_time }));
  drawOverlays();
}

document.getElementById('refreshPositions').onclick = async () => { await loadMyObservations(); await loadCommunityObservations(); };

supabase.auth.onAuthStateChange(async () => { await loadMyObservations(); await loadCommunityObservations(); });
</script>
</body>
</html>
